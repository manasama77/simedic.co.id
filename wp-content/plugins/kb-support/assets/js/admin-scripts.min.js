function kbs_load_ticket_replies(a,b,c){jQuery("#kbs-replies-loader").html('<img src="'+kbs_vars.ajax_loader+'" />'),jQuery.post(ajaxurl,{action:"kbs_display_ticket_replies",kbs_ticket_id:a,kbs_reply_id:b,kbs_page:c},function(a){jQuery(".kbs-historic-reply-option-fields").append(a),jQuery("#kbs-replies-loader").html("")})}function kbs_load_ticket_notes(a,b){jQuery("#kbs-notes-loader").html('<img src="'+kbs_vars.ajax_loader+'" />'),jQuery.post(ajaxurl,{action:"kbs_display_ticket_notes",kbs_ticket_id:a,kbs_note_id:b},function(a){jQuery(".kbs-notes-option-fields").prepend(a),jQuery("#kbs-notes-loader").html("")})}var KBSShowNotice,kbs_vars;jQuery(document).ready(function(a){var b=a(".kbs_datepicker");if(b.length>0){var c="mm/dd/yy";b.datepicker({dateFormat:c})}a(".kbs_select_chosen").chosen({inherit_select_classes:!0,placeholder_text_single:kbs_vars.one_option,placeholder_text_multiple:kbs_vars.one_or_more_option}),a(".kbs_select_chosen .chosen-search input").each(function(){var b=a(this).parent().parent().parent().prev("select.kbs_select_chosen"),c=b.data("search-placeholder");a(this).attr("placeholder",c)}),a(".chosen-choices").on("click",function(){var b=a(this).parent().prev().data("search-placeholder");"undefined"==typeof b&&(b=kbs_vars.type_to_search),a(this).children("li").children("input").attr("placeholder",b)}),a(document).on("click",".notice-kbs-dismiss .notice-dismiss",function(){var b=a(this).closest(".notice-kbs-dismiss").data("notice"),c={notice:b,action:"kbs_dismiss_notice"};a.ajax({type:"POST",dataType:"json",data:c,url:ajaxurl})});var d={init:function(){this.general(),this.uploads()},general:function(){var b=a(".kbs-color-picker");b.length&&b.wpColorPicker(),a(".logged_in_only").length&&a(".logged_in_only").is(":checked")&&a(".kbs_option_auto_add_user").hide(),a(".recaptcha_version").length&&"v2"!==a(".recaptcha_version").val()&&(a(".kbs_option_recaptcha_theme").hide(),a(".kbs_option_recaptcha_type").hide(),a(".kbs_option_recaptcha_size").hide()),a(document.body).on("change",".logged_in_only",function(){a(this).is(":checked")?a(".kbs_option_auto_add_user").fadeOut("fast"):a(".kbs_option_auto_add_user").fadeIn("fast")}),a(document.body).on("change",".recaptcha_version",function(){"v2"!==a(".recaptcha_version").val()?(a(".kbs_option_recaptcha_theme").fadeOut("fast"),a(".kbs_option_recaptcha_type").fadeOut("fast"),a(".kbs_option_recaptcha_size").fadeOut("fast")):(a(".kbs_option_recaptcha_theme").fadeIn("fast"),a(".kbs_option_recaptcha_type").fadeIn("fast"),a(".kbs_option_recaptcha_size").fadeIn("fast"))})},uploads:function(){if("undefined"==typeof wp||"1"!==kbs_vars.new_media_ui){var b=a(".kbs_settings_upload_button");b.length>0&&(window.formfield="",a(document.body).on("click",b,function(b){b.preventDefault(),window.formfield=a(this).parent().prev(),window.tbframe_interval=setInterval(function(){jQuery("#TB_iframeContent").contents().find(".savesend .button").val(kbs_vars.use_this_file).end().find("#insert-gallery, .wp-post-thumbnail").hide()},2e3),tb_show(kbs_vars.add_new_ticket,"media-upload.php?TB_iframe=true")}),window.kbs_send_to_editor=window.send_to_editor,window.send_to_editor=function(b){window.formfield?(imgurl=a("a","<div>"+b+"</div>").attr("href"),window.formfield.val(imgurl),window.clearInterval(window.tbframe_interval),tb_remove()):window.kbs_send_to_editor(b),window.send_to_editor=window.kbs_send_to_editor,window.formfield="",window.imagefield=!1})}else{var c;window.formfield="",a(document.body).on("click",".kbs_settings_upload_button",function(b){b.preventDefault();var d=a(this);return window.formfield=a(this).parent().prev(),c?void c.open():(c=wp.media.frames.file_frame=wp.media({frame:"post",state:"insert",title:d.data("uploader_title"),button:{text:d.data("uploader_button_text")},multiple:!1}),c.on("menu:render:default",function(a){var b={};a.unset("library-separator"),a.unset("gallery"),a.unset("featured-image"),a.unset("embed"),a.set(b)}),c.on("insert",function(){var a=c.state().get("selection");a.each(function(a){a=a.toJSON(),window.formfield.val(a.url)})}),void c.open())})}}};d.init();var e={init:function(){this.notes(),this.options(),this.participants(),this.reply(),this.save()},save:function(){a(document.body).on("click","#save-post",function(){var b="",c="undefined"!=typeof tinyMCE&&tinyMCE.activeEditor&&!tinyMCE.activeEditor.isHidden();return c&&tinyMCE.triggerSave(),b=a("#kbs_ticket_reply").val(),b.length>0?confirm(kbs_vars.reply_has_data):void 0}),a(document.body).on("change","#ticket_status",function(){"kbs_ticket"!==kbs_vars.post_type||"closed"!==a(this).val()||kbs_vars.disable_closure_email?(a("#kbs-closure-option").remove(),a("#kbs-closure-email").remove(),a('label[for="kbs-closure-email"]').remove()):(a(this).parent().append('<br id="kbs-closure-option">'),a(this).parent().append('<input type="checkbox" id="kbs-closure-email" name="kbs_closure_email" value="1" style="margin-top:0; margin-left: 4px;">'),a(this).parent().append('<label for="kbs-closure-email">'+kbs_vars.send_closure_email+"</label>"))})},options:function(){a(document.body).on("click",".toggle-flagged-status-option-section",function(b){b.preventDefault();var c={ticket_id:kbs_vars.post_id,flagged:a(this).data("flag"),action:"kbs_set_ticket_flagged_status"};a.ajax({type:"POST",dataType:"json",data:c,url:ajaxurl,beforeSend:function(){a("#kbs-ticket-metabox-fields").addClass("kbs-mute"),a(".toggle-flagged-status-option-section").html(kbs_vars.please_wait)},success:function(b){!0===b.success&&("flagged"===b.data.flagged?(a("#kbs-ticket-flag-notice").show(),a(".toggle-flagged-status-option-section").html(kbs_vars.ticket_unflag),a(".toggle-flagged-status-option-section").data("flag","0")):(a("#kbs-ticket-flag-notice").hide(),a(".toggle-flagged-status-option-section").html(kbs_vars.ticket_flag),a(".toggle-flagged-status-option-section").data("flag","1")),kbs_load_ticket_notes(kbs_vars.post_id,b.data.note_id)),a("#kbs-ticket-metabox-fields").removeClass("kbs-mute")}}).fail(function(a){window.console&&window.console.log&&console.log(a)})}),a(document.body).on("click",".toggle-add-reply-option-section",function(b){b.preventDefault(),a("html, body").animate({scrollTop:a(".kbs-historic-reply-option-fields").offset().top},500)}),a(document.body).on("click",".toggle-view-participants-option-section",function(b){b.preventDefault();var c=a(this).html()===kbs_vars.view_participants?!0:!1;c?a(this).html(kbs_vars.hide_participants):a(this).html(kbs_vars.view_participants),a("#kbs-ticket-participants-fields").slideToggle(),c&&a("html, body").animate({scrollTop:a("#kbs-ticket-participants-fields").offset().top},500)}),a(document.body).on("click",".toggle-view-submission-option-section",function(b){b.preventDefault();var c=a(this).html()===kbs_vars.view_submission?!0:!1;c?a(this).html(kbs_vars.hide_submission):a(this).html(kbs_vars.view_submission),a("#kbs-ticket-formdata-fields").slideToggle(),c&&a("html, body").animate({scrollTop:a("#kbs-ticket-formdata-fields").offset().top},500)})},participants:function(){a(document.body).on("click","#kbs-add-participant",function(b){b.preventDefault(b);var c=a("#participant_id").val(),d=a("#participant_email").val();if("-1"!==c||d){var e={ticket_id:kbs_vars.post_id,participant:c,email:d,action:"kbs_add_participant"};a.ajax({type:"POST",dataType:"json",data:e,url:ajaxurl,beforeSend:function(){a("#kbs-ticket-participants-fields").addClass("kbs-mute"),a("#kbs-add-participant").attr("disabled",!0)},success:function(b){!0===b.success&&("-1"!==c&&a("#participant_id option:selected").remove(),a(".kbs-ticket-participants-list").html(b.data.list),a("#participant-count").text(b.data.count)),a("#participant_email").empty(),a("#participant_id").val("-1"),a("#participant_id").trigger("chosen:updated"),a("#kbs-add-participant").attr("disabled",!1),a("#kbs-ticket-participants-fields").removeClass("kbs-mute")}}).fail(function(a){window.console&&window.console.log&&console.log(a)})}}),a(document.body).on("click",".remove-participant",function(b){b.preventDefault(b);var c=a(this).data("participant"),d={participant:c,ticket_id:kbs_vars.post_id,action:"kbs_remove_participant"};a.ajax({type:"POST",dataType:"json",data:d,url:ajaxurl,beforeSend:function(){a("#kbs-ticket-participants-fields").addClass("kbs-mute"),a("#kbs-add-participant").attr("disabled",!0)},success:function(b){!0===b.success&&(a(".kbs-ticket-participants-list").html(b.data.list),a("#participant-count").text(b.data.count)),a("#kbs-add-participant").attr("disabled",!1),a("#kbs-ticket-participants-fields").removeClass("kbs-mute")}}).fail(function(a){window.console&&window.console.log&&console.log(a)})})},reply:function(){"1"===kbs_vars.editing_ticket&&"1"===kbs_vars.reply_alerts&&(a(document).on("heartbeat-send",function(b,c){var d=a("#kbs-latest-reply").val();c.kbs_last_reply=d,c.kbs_ticket_id=kbs_vars.post_id}),a(document).on("heartbeat-tick",function(b,c){c.has_new_reply&&(a("#kbs-latest-reply").val(c.has_new_reply),confirm(kbs_vars.new_reply_notice)&&(a(".kbs-historic-reply-option-fields").empty(),kbs_load_ticket_replies(kbs_vars.post_id,0,1)))})),a(document.body).on("click",".reply-delete",function(b){b.preventDefault(),confirm(kbs_vars.delete_ticket_warn)&&(window.location=a(this).attr("href"))}),a(document.body).on("click","#kbs-reply-close, #kbs-reply-update",function(b){b.preventDefault();var c=kbs_vars.post_id,d="",e=kbs_vars.agent_set_status?a("#ticket_reply_status").val():kbs_vars.default_reply_status,f=a("#post").serialize(),g="undefined"!=typeof tinyMCE&&tinyMCE.activeEditor&&!tinyMCE.activeEditor.isHidden();if(g&&tinyMCE.triggerSave(),d=a("#kbs_ticket_reply").val(),0===d.length)return window.alert(kbs_vars.no_ticket_reply_content),!1;if("kbs-reply-close"===b.target.id||"closed"===e){var h=confirm(kbs_vars.ticket_confirm_close);if(h===!1)return}var i={ticket_id:c,response:d,status:e,close_ticket:"kbs-reply-close"===b.target.id?1:0,form_data:f,action:"kbs_insert_ticket_reply"};a.ajax({type:"POST",dataType:"json",data:i,url:ajaxurl,beforeSend:function(){a(".kbs-reply").hide(),a("#kbs-new-reply-loader").html('<img src="'+kbs_vars.ajax_loader+'" />')},success:function(b){return b.reply_id?(kbs_load_ticket_replies(c,b.reply_id,1),window.location.href=kbs_vars.admin_url+"?kbs-action=ticket_reply_added&ticket_id="+c,!0):(window.alert(kbs_vars.reply_not_added),a("#kbs-new-reply-loader").html(""),void a(".kbs-reply").show())}}).fail(function(a){window.console&&window.console.log&&console.log(a)})}),a(document.body).on("click","#kbs-replies-next-page",function(){var b=a("#kbs-replies-next-page").data("ticket-id"),c=a("#kbs-replies-next-page").data("load-page");a(".kbs-replies-load-more").remove(),kbs_load_ticket_replies(b,0,c)})},notes:function(){a(document.body).on("click","#kbs-add-note",function(){var b=a("#kbs_new_note").val(),c=kbs_vars.post_id;if(b.length<1)return void window.alert(kbs_vars.no_note_content);var d={ticket_id:c,note_content:b,action:"kbs_insert_ticket_note"};a.ajax({type:"POST",dataType:"json",data:d,url:ajaxurl,beforeSend:function(){a("#kbs-add-note").hide(),a("#kbs-new-note-loader").html('<img src="'+kbs_vars.ajax_loader+'" />')},success:function(b){b.note_id?(kbs_load_ticket_notes(c,b.note_id),a("#kbs_new_note").val("")):window.alert(kbs_vars.note_not_added),a("#kbs-new-note-loader").html(""),a("#kbs-add-note").show()}}).fail(function(a){window.console&&window.console.log&&console.log(a)})}),"1"===kbs_vars.editing_ticket&&setTimeout(function(){kbs_load_ticket_replies(kbs_vars.post_id,0,1),kbs_load_ticket_notes(kbs_vars.post_id,0)},200)}};a(document.body).on("click",".toggle-view-reply-option-section",function(b){b.preventDefault();var c=a(this).html()===kbs_vars.view_reply?!0:!1;c?a(this).html(kbs_vars.hide_reply):a(this).html(kbs_vars.view_reply);var d=a(this).parents(".kbs-replies-row-header");d.siblings(".kbs-replies-content-wrap").slideToggle()}),a(document.body).on("click",".toggle-view-note-option-section",function(b){b.preventDefault();var c=a(this).html()===kbs_vars.view_note?!0:!1;c?a(this).html(kbs_vars.hide_note):a(this).html(kbs_vars.view_note);var d=a(this).parents(".kbs-notes-row-header");d.siblings(".kbs-notes-content-wrap").slideToggle()}),e.init();var f={init:function(){this.forms(),this.move()},forms:function(){var b=function(b){"text"===b||"date_field"===b||"department"===b||"email"===b||"number"===b||"select"===b||"textarea"===b||"url"===b?a("#kbs_meta_field_placeholder_wrap").show():a("#kbs_meta_field_placeholder_wrap").hide(),"text"===b||"date_field"===b||"department"===b||"email"===b||"hidden"===b||"number"===b||"select"===b||"textarea"===b||"url"===b?a("#kbs_meta_field_hide_label_wrap").show():a("#kbs_meta_field_hide_label_wrap").hide(),"select"===b||"checkbox_list"===b||"radio"===b?a("#kbs_meta_field_select_options_wrap").show():a("#kbs_meta_field_select_options_wrap").hide(),"select"===b?a("#kbs_meta_field_select_multiple_wrap").show():a("#kbs_meta_field_select_multiple_wrap").hide(),"select"===b||"department"===b||"ticket_category_dropdown"===b?(a("#kbs_meta_field_select_blank_wrap").show(),a("#kbs_meta_field_select_searchable_wrap").show()):(a("#kbs_meta_field_select_blank_wrap").hide(),a("#kbs_meta_field_select_searchable_wrap").hide()),"checkbox"===b?a("#kbs_meta_field_option_selected_wrap").show():a("#kbs_meta_field_option_selected_wrap").hide(),"checkbox"===b||"file_upload"===b?a("#kbs_meta_field_required_wrap").hide():a("#kbs_meta_field_required_wrap").show(),"recaptcha"===b?(a("#kbs_meta_field_required_wrap").hide(),a("#kbs_meta_field_label_class_wrap").hide(),a("#kbs_meta_field_input_class_wrap").hide()):(a("#kbs_meta_field_required_wrap").show(),a("#kbs_meta_field_label_class_wrap").show(),a("#kbs_meta_field_input_class_wrap").show()),"text"===b||"email"===b||"hidden"===b||"url"===b||"textarea"===b||"rich_editor"===b||"department"===b?a("#kbs_meta_field_mapping_wrap").show():a("#kbs_meta_field_mapping_wrap").hide(),"hidden"===b?a("#kbs_meta_field_value_wrap").show():a("#kbs_meta_field_value_wrap").hide(),"post_title"===a("#kbs_field_mapping").val()?a("#kbs_meta_field_kb_search_wrap").show():a("#kbs_meta_field_kb_search_wrap").hide()};kbs_vars.editing_field_type&&b(kbs_vars.editing_field_type);var c=a(".kbs_field_type");a(document.body).on("change",c,function(){b(c.val())}),a(document.body).on("change",a("#kbs_field_mapping"),function(){"post_title"===a("#kbs_field_mapping").val()?a("#kbs_meta_field_kb_search_wrap").show():a("#kbs_meta_field_kb_search_wrap").hide()}),a(document.body).on("change",a("#kbs_field_select_chosen"),function(){a("#kbs_field_select_chosen").is(":checked")?a("#kbs_meta_field_select_search_text_wrap").show("fast"):a("#kbs_meta_field_select_search_text_wrap").hide("fast")}),a(document.body).on("click","#kbs-add-form-field",function(b){if(b.preventDefault(),a("#kbs_field_label").val().length<1)return window.alert(kbs_vars.field_label_missing),!1;if("-1"===a("#kbs_field_type").val())return window.alert(kbs_vars.field_type_missing),!1;var c=a("#form_return_url").val(),d={action:"kbs_add_form_field",blank:a("#kbs_field_select_blank").val(),chosen:a("#kbs_field_select_chosen").is(":checked")?a("#kbs_field_select_chosen").val():0,chosen_search:a("#kbs_field_select_chosen_search").val(),description:a("#kbs_field_description").val(),description_pos:a("input[name=kbs_field_description_pos]").filter(":checked").val(),form_data:a("#post").serialize(),form_id:kbs_vars.post_id,hide_label:a("#kbs_field_hide_label").is(":checked")?a("#kbs_field_hide_label").val():0,input_class:a("#kbs_field_input_class").val(),kb_search:a("#kbs_field_kb_search").is(":checked")?a("#kbs_field_kb_search").val():0,label:a("#kbs_field_label").val(),label_class:a("#kbs_field_label_class").val(),mapping:a("#kbs_field_mapping").val(),placeholder:a("#kbs_field_placeholder").val(),required:a("#kbs_field_required").is(":checked")?a("#kbs_field_required").val():0,selected:a("#kbs_field_option_selected").is(":checked")?a("#kbs_field_option_selected").val():0,select_multiple:a("#kbs_field_select_multiple").is(":checked")?a("#kbs_field_select_multiple").val():0,select_options:a("textarea#kbs_field_select_options").val(),type:a("#kbs_field_type").val(),value:a("#kbs_field_value").val()};a.ajax({type:"POST",dataType:"json",data:d,url:ajaxurl,beforeSend:function(){a("#kbs-field-add").addClass("kbs-hidden"),a("#kbs-loading").removeClass("kbs-hidden")},success:function(a){return window.location.href=c+"&kbs-message="+a.message,!0}}).fail(function(b){a("#kbs-field-add").removeClass("kbs-hidden"),a("#kbs-loading").addClass("kbs-hidden"),window.console&&window.console.log&&console.log(b)})}),a(document.body).on("click","#kbs-save-form-field",function(b){if(b.preventDefault(),a("#kbs_field_label").val().length<1)return window.alert(kbs_vars.field_label_missing),!1;if("-1"===a("#kbs_field_type").val())return window.alert(kbs_vars.field_type_missing),!1;var c=a("#form_return_url").val(),d={action:"kbs_save_form_field",blank:a("#kbs_field_select_blank").val(),chosen:a("#kbs_field_select_chosen").is(":checked")?a("#kbs_field_select_chosen").val():0,chosen_search:a("#kbs_field_select_chosen_search").val(),description:a("#kbs_field_description").val(),description_pos:a("input[name=kbs_field_description_pos]").filter(":checked").val(),field_id:a("#kbs_edit_field").val(),form_data:a("#post").serialize(),form_id:kbs_vars.post_id,hide_label:a("#kbs_field_hide_label").is(":checked")?a("#kbs_field_hide_label").val():0,input_class:a("#kbs_field_input_class").val(),kb_search:a("#kbs_field_kb_search").is(":checked")?a("#kbs_field_kb_search").val():0,label:a("#kbs_field_label").val(),label_class:a("#kbs_field_label_class").val(),mapping:a("#kbs_field_mapping").val(),placeholder:a("#kbs_field_placeholder").val(),required:a("#kbs_field_required").is(":checked")?a("#kbs_field_required").val():0,selected:a("#kbs_field_option_selected").is(":checked")?a("#kbs_field_option_selected").val():0,select_options:a("textarea#kbs_field_select_options").val(),select_multiple:a("#kbs_field_select_multiple").is(":checked")?a("#kbs_field_select_multiple").val():0,type:a("#kbs_field_type").val(),value:a("#kbs_field_value").val()};a.ajax({type:"POST",dataType:"json",data:d,url:ajaxurl,beforeSend:function(){a("#kbs-field-save").addClass("kbs-hidden"),a("#kbs-loading").removeClass("kbs-hidden")},success:function(a){return window.location.href=c+"&kbs-message="+a.message,!0}}).fail(function(b){a("#kbs-field-save").removeClass("kbs-hidden"),a("#kbs-loading").addClass("kbs-hidden"),window.console&&window.console.log&&console.log(b)})})},move:function(){a(".kbs_sortable_table tbody").sortable({handle:".kbs_draghandle",items:".kbs_sortable_row",opacity:.6,cursor:"move",axis:"y",update:function(){var b=a(this).sortable("serialize")+"&action=kbs_order_form_fields";a.post(ajaxurl,b,function(){})}})}};f.init();var g={vars:{customer_wrap_editable:a(".kbs-customer-wrapper .editable"),customer_wrap_edit_item:a(".kbs-customer-wrapper .edit-item"),user_id:a('input[name="customerinfo[user_id]"]'),note:a("#customer-note")},init:function(){this.add_customer(),this.new_customer(),this.edit_customer(),this.cancel_edit(),this.add_email(),this.user_search(),this.remove_user(),this.add_note(),this.delete_checked()},add_customer:function(){a(document.body).on("click","#kbs-add-customer-save",function(b){b.preventDefault();var c=a(this),d=c.parent(),e=a("#customer-name").val(),f=a("#customer_company").val(),g=a("#customer-email").val(),h=a("add_customer_nonce").val(),i={action:"kbs_add_customer",customer_name:e,customer_company:f,customer_email:g,_wpnonce:h};a.ajax({type:"POST",dataType:"json",data:i,url:ajaxurl,beforeSend:function(){a(".notice-wrap").html(""),d.find(".spinner").css("visibility","visible"),c.attr("disabled",!0)},success:function(b){return b.error?(c.attr("disabled",!1),a(".notice-wrap").html('<div class="notice notice-error"><p>'+b.message+"</p></div>"),d.find(".spinner").css("visibility","hidden"),void 0):(window.location.href=b.redirect,!0)}}).fail(function(a){window.console&&window.console.log&&console.log(a)})})},new_customer:function(){a(document.body).on("click","#kbs-new-customer-save",function(b){b.preventDefault();var c=a(this),d=a("#kbs_name").val(),e=a("#kbs_email").val(),f=a("#kbs_company").val();if(""===d)return void alert(kbs_vars.customer_name_required);if(""===e)return void alert(kbs_vars.customer_email_required);var g={action:"kbs_new_customer_for_ticket",customer_name:d,customer_email:e,customer_company:f};a.ajax({type:"POST",dataType:"json",data:g,url:ajaxurl,beforeSend:function(){c.attr("disabled",!0),a("#add-customer").addClass("kbs-mute")},success:function(b){b.success?(a("#kbs_customer_id").append(b.data.option),a("#kbs_customer_id").val(b.data.id),a("#kbs_customer_id").trigger("chosen:updated"),c.attr("disabled",!1),a("#kbs_name").val(""),a("#kbs_email").val(""),a("#kbs_company").val("-1"),a("#kbs_company").trigger("chosen:updated"),tb_remove()):(c.attr("disabled",!1),b.data.message&&alert(b.data.message))}}).fail(function(a){window.console&&window.console.log&&console.log(a)})})},edit_customer:function(){a(document.body).on("click","#edit-customer",function(a){a.preventDefault(),g.vars.customer_wrap_editable.hide(),g.vars.customer_wrap_edit_item.fadeIn().css("display","block")})},cancel_edit:function(){a(document.body).on("click","#kbs-edit-customer-cancel",function(b){b.preventDefault(),g.vars.customer_wrap_edit_item.hide(),g.vars.customer_wrap_editable.show(),a(".kbs_user_search_results").html("")})},add_email:function(){a(document.body).on("click","#add-customer-email",function(b){b.preventDefault();var c=a(this),d=c.parent();d.parent().find(".notice-wrap").remove(),d.find(".spinner").css("visibility","visible"),c.attr("disabled",!0);var e=d.find('input[name="customer-id"]').val(),f=d.find('input[name="additional-email"]').val(),g=d.find('input[name="make-additional-primary"]').is(":checked"),h=d.find('input[name="add_email_nonce"]').val(),i={kbs_action:"customer-add-email",customer_id:e,email:f,primary:g,_wpnonce:h};a.post(ajaxurl,i,function(a){!0===a.success?window.location.href=a.redirect:(c.attr("disabled",!1),d.after('<div class="notice-wrap"><div class="notice notice-error inline"><p>'+a.message+"</p></div></div>"),d.find(".spinner").css("visibility","hidden"))},"json")})},user_search:function(){a(document.body).on("click.kbsSelectUser",".kbs_user_search_results a",function(b){b.preventDefault();var c=a(this).data("userid");g.vars.user_id.val(c)})},remove_user:function(){a(document.body).on("click","#disconnect-customer",function(b){b.preventDefault();var c=a('input[name="customerinfo[id]"]').val(),d={kbs_action:"disconnect-userid",customer_id:c,_wpnonce:a("#edit-customer-info #_wpnonce").val()};a.post(ajaxurl,d,function(){window.location.href=window.location.href},"json")})},add_note:function(){a(document.body).on("click","#add-customer-note",function(b){b.preventDefault();var c={kbs_action:"add-customer-note",customer_id:a("#customer-id").val(),customer_note:g.vars.note.val(),add_customer_note_nonce:a("#add_customer_note_nonce").val()};if(c.customer_note)a.ajax({type:"POST",data:c,url:ajaxurl,success:function(b){a("#kbs-customer-notes").prepend(b),a(".kbs-no-customer-notes").hide(),g.vars.note.val("")}}).fail(function(a){window.console&&window.console.log&&console.log(a)});else{var d=g.vars.note.css("border-color");g.vars.note.css("border-color","red"),setTimeout(function(){g.vars.note.css("border-color",d)},500)}})},delete_checked:function(){a("#kbs-customer-delete-confirm").change(function(){var b=a("#kbs-delete-customer");a(this).prop("checked")?b.attr("disabled",!1):b.attr("disabled",!0)})}};g.init();var h={init:function(){this.contacts()},contacts:function(){a("#_kbs_company_customer").change(function(){if(0!==a("#_kbs_company_customer").val()){var b={action:"kbs_get_customer_data",company_id:kbs_vars.post_id,customer_id:a("#_kbs_company_customer").val()};a.ajax({type:"POST",dataType:"json",data:b,url:ajaxurl,success:function(b){a("#_kbs_company_contact").val(b.name),a("#_kbs_company_email").val(b.email),a("#_kbs_company_phone").val(b.phone),a("#_kbs_company_website").val(b.url)}}).fail(function(a){window.console&&window.console.log&&console.log(a)})}})}};h.init();var i={init:function(){this.submit(),this.dismiss_message()},submit:function(){var b=this;a(document.body).on("submit",".kbs-export-form",function(c){c.preventDefault();var d=a(this).find('input[type="submit"]');if(!d.hasClass("button-disabled")){var e=a(this).serialize();d.addClass("button-disabled"),a(this).find(".notice-wrap").remove(),a(this).append('<div class="notice-wrap"><span class="spinner is-active"></span><div class="kbs-progress"><div></div></div></div>'),b.process_step(1,e,b)}})},process_step:function(b,c,d){a.ajax({type:"POST",url:ajaxurl,data:{form:c,action:"kbs_do_ajax_export",step:b},dataType:"json",success:function(b){if("done"===b.step||b.error||b.success){var e=a(".kbs-export-form").find(".kbs-progress").parent().parent(),f=e.find(".notice-wrap");if(e.find(".button-disabled").removeClass("button-disabled"),b.error){var g=b.message;f.html('<div class="updated error"><p>'+g+"</p></div>")}else if(b.success){var h=b.message;f.html('<div id="kbs-batch-success" class="updated notice is-dismissible"><p>'+h+'<span class="notice-dismiss"></span></p></div>')}else f.remove(),window.location=b.url}else a(".kbs-progress div").animate({width:b.percentage+"%"},50,function(){}),d.process_step(parseInt(b.step),c,d)}}).fail(function(a){window.console&&window.console.log&&console.log(a)})},dismiss_message:function(){a("body").on("click","#kbs-batch-success .notice-dismiss",function(){a("#kbs-batch-success").parent().slideUp("fast")})}};i.init(),a(".kbs-ajax-user-search").keyup(function(){var b=a(this).val(),c="";a(this).data("exclude")&&(c=a(this).data("exclude")),a(".kbs-ajax").show();var d={action:"kbs_search_users",user_name:b,exclude:c};document.body.style.cursor="wait",a.ajax({type:"POST",data:d,dataType:"json",url:ajaxurl,success:function(b){a(".kbs-ajax").hide(),a(".kbs_user_search_results").removeClass("hidden"),a(".kbs_user_search_results span").html(""),a(b.results).appendTo(".kbs_user_search_results span"),document.body.style.cursor="default"}})}),a(document.body).on("click.kbsSelectUser",".kbs_user_search_results span a",function(b){b.preventDefault();var c=a(this).data("login");a(".kbs-ajax-user-search").val(c),a(".kbs_user_search_results").addClass("hidden"),a(".kbs_user_search_results span").html("")}),a(document.body).on("click.kbsCancelUserSearch",".kbs_user_search_results a.kbs-ajax-user-cancel",function(b){b.preventDefault(),a(".kbs-ajax-user-search").val(""),a(".kbs_user_search_results").addClass("hidden"),a(".kbs_user_search_results span").html("")}),a("#kbs_dashboard_tickets").length&&a.ajax({type:"GET",data:{action:"kbs_load_dashboard_widget"},url:ajaxurl,success:function(b){a("#kbs_dashboard_tickets .inside").html(b)}}),a(document).on("keydown",".customer-note-input",function(b){13===b.keyCode&&(b.metaKey||b.ctrlKey)&&a("#add-customer-note").click()})}),KBSShowNotice={warn:function(a){void 0===a&&(a="ticket");var b=kbs_vars.delete_ticket_warn||"";return confirm(b)?!0:!1},note:function(a){alert(a)}};